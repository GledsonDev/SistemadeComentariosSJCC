<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Mural de Comentários - Jornal do Commercio</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/styleIndex.css') }}">
    <style>
        /* Estilo adicional para placeholders de imagem */
        .profile-pic[src=""], .profile-pic-small[src=""] {
            background-color: #f0f2f5;
            border: 1px solid #e0e0e0;
        }
        .profile-pic.img-placeholder, .profile-pic-small.img-placeholder { /* Renomeado para evitar conflito com [src=""] */
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            display: inline-block;
            /* As dimensões (width, height, border-radius) devem vir do .profile-pic ou .profile-pic-small no CSS principal */
        }
        /* Estilo para o botão de sair no cabeçalho */
        .user-info .logout-button { 
            padding: 6px 12px;
            font-size: 0.9em;
            margin-left: 10px;
            background-color: #e4e6eb;
            color: #050505;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .user-info .logout-button:hover {
            background-color: #d8dbdf;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="page-header">
            <img src="{{ url_for('static', path='/logoJC.svg') }}" alt="Logo Jornal do Commercio" class="logo-jc">
            <div id="user-greeting" class="user-info"></div>
        </header>

        <div id="auth-links" class="auth-actions" style="display:none;"> 
            <a href="{{ url_for('read_login_page') }}" class="auth-button">Entrar</a>
            <a href="{{ url_for('read_register_page') }}" class="auth-button">Cadastrar</a>
        </div>

        <div id="comment-form-area" class="comment-form" style="display:none;">
            <h2>Deixe seu comentário:</h2>
            <textarea id="comment-text" placeholder="Escreva algo construtivo..."></textarea>
            <button onclick="submitNewComment()" class="submit-button">Enviar Comentário</button> <p id="comment-error" class="error-text"></p>
            <p id="comment-success" class="success-text"></p>
        </div>

        <section class="comments-section">
            <h2>Comentários Recentes:</h2>
            <div id="comments-list" class="comments-list">
                <p>Carregando comentários...</p>
            </div>
        </section>
    </div>

    <script>
        let currentUser = null;

        function createUserImageElement(imageUrl, altText, className) {
            if (!imageUrl || imageUrl.trim() === "") {
                const placeholder = document.createElement('div');
                placeholder.className = className + ' img-placeholder'; 
                return placeholder; 
            }

            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = altText || "Avatar";
            img.className = className;
            
            img.onerror = function() {
                const placeholder = document.createElement('div');
                placeholder.className = className + ' img-placeholder';
                if (this.parentNode) {
                    this.parentNode.replaceChild(placeholder, this);
                }
            };
            return img;
        }

        function checkLoginStatus() {
            const userDataString = localStorage.getItem('comentarioUser');
            const userGreetingDiv = document.getElementById('user-greeting');
            const authLinksDiv = document.getElementById('auth-links');
            const commentFormArea = document.getElementById('comment-form-area'); 
            // Linha removida: const topCommentText = document.getElementById('top-comment-text');

            userGreetingDiv.innerHTML = ''; 

            if (userDataString) {
                currentUser = JSON.parse(userDataString);
                
                let greetingHTML = `<span>Olá, <strong>${escapeHTML(currentUser.nome)}</strong>!</span>`;
                const userImgElement = createUserImageElement(currentUser.imagem, "Perfil", "profile-pic-small");
                if (userImgElement) {
                    greetingHTML += userImgElement.outerHTML;
                }
                greetingHTML += `<button onclick="logout()" class="logout-button">Sair</button>`; 
                userGreetingDiv.innerHTML = greetingHTML;
                
                authLinksDiv.style.display = 'none';
                commentFormArea.style.display = 'block'; // Mostra o formulário principal se logado
                // Linhas removidas: manipulação de topCommentText.disabled e placeholder

            } else {
                currentUser = null;
                authLinksDiv.style.display = 'flex';
                commentFormArea.style.display = 'none'; // Esconde o formulário principal se não logado
                // Linhas removidas: manipulação de topCommentText.disabled e placeholder
            }
        }

        function logout() {
            localStorage.removeItem('comentarioUser');
            currentUser = null;
            checkLoginStatus(); 
        }

        async function loadComments() {
            const commentsListDiv = document.getElementById('comments-list');
            commentsListDiv.innerHTML = '<p>Carregando comentários...</p>';
            try {
                const response = await fetch("{{ url_for('get_approved_comments_endpoint') }}"); 
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: `Falha ao carregar comentários. Status: ${response.status}` }));
                    throw new Error(errorData.detail);
                }
                
                const comments = await response.json();
                commentsListDiv.innerHTML = ''; 

                if (comments.length === 0) {
                    commentsListDiv.innerHTML = '<p>Ainda não há comentários aprovados.</p>';
                    if (!currentUser) {
                        commentsListDiv.innerHTML += '<p>Faça login para ser o primeiro a comentar!</p>';
                    }
                    return;
                }

                comments.forEach(comment => {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'comment-item';
                    
                    let commentHTML = '';
                    const commentImgElement = createUserImageElement(comment.autor_imagem, comment.autor_nome, "profile-pic");
                    
                    if (commentImgElement) {
                        commentHTML += commentImgElement.outerHTML;
                    }
                    
                    commentHTML += `
                        <div class="comment-content">
                            <strong>${escapeHTML(comment.autor_nome)}</strong>
                            <p>${escapeHTML(comment.texto)}</p>
                        </div>
                    `;
                    commentDiv.innerHTML = commentHTML;
                    commentsListDiv.appendChild(commentDiv);
                });
            } catch (error) {
                commentsListDiv.innerHTML = `<p class="error-text">Erro ao carregar comentários: ${error.message}</p>`;
                console.error('Erro ao carregar comentários:', error);
            }
        }

        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            const map = {
                '&': '&amp;', '<': '&lt;', '>': '&gt;',
                '"': '&quot;', "'": '&#039;'
            };
            return str.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        async function submitNewComment() { // Removido o parâmetro commentSource
            // Agora sempre pega do formulário principal
            const commentText = document.getElementById('comment-text').value;
            const successElement = document.getElementById('comment-success');
            const errorElement = document.getElementById('comment-error');   
            
            if (errorElement) errorElement.textContent = '';
            if (successElement) successElement.textContent = '';

            if (!currentUser) {
                // Esta verificação pode ser redundante se o formulário só é visível quando logado,
                // mas é uma boa prática manter.
                alert('Você precisa estar logado para comentar.');
                return;
            }
            if (!commentText.trim()) {
                errorElement.textContent = 'O comentário não pode estar vazio.'; // Usa o elemento de erro do formulário
                // alert('O comentário não pode estar vazio.'); // Alternativa com alert
                return;
            }

            const formData = new FormData();
            formData.append('nome_autor', currentUser.nome);
            formData.append('texto', commentText); 

            try {
                const response = await fetch("{{ url_for('submit_comment_endpoint') }}", {
                    method: 'POST',
                    body: formData 
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Falha ao enviar comentário.');
                }
                
                document.getElementById('comment-text').value = ''; // Limpa o textarea do formulário
                
                if (result.aprovado) {
                    if(successElement) successElement.textContent = 'Comentário enviado e aprovado!';
                    loadComments(); 
                } else {
                    if(successElement) successElement.textContent = 'Comentário enviado e aguardando moderação (ou não foi aprovado).';
                }
                if(successElement) {
                    setTimeout(() => { successElement.textContent = ''; }, 5000);
                }

            } catch (error) {
                if(errorElement) errorElement.textContent = error.message;
                console.error('Erro ao enviar comentário:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus(); 
            loadComments();     

            // Bloco do event listener para topCommentTextArea foi REMOVIDO
        });
    </script>
</body>
</html>